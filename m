Return-Path: <sparclinux-owner@vger.kernel.org>
X-Original-To: lists+sparclinux@lfdr.de
Delivered-To: lists+sparclinux@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id C2E3D254B16
	for <lists+sparclinux@lfdr.de>; Thu, 27 Aug 2020 18:47:42 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727024AbgH0Qrj (ORCPT <rfc822;lists+sparclinux@lfdr.de>);
        Thu, 27 Aug 2020 12:47:39 -0400
Received: from shadbolt.e.decadent.org.uk ([88.96.1.126]:55578 "EHLO
        shadbolt.e.decadent.org.uk" rhost-flags-OK-OK-OK-OK)
        by vger.kernel.org with ESMTP id S1726946AbgH0Qri (ORCPT
        <rfc822;sparclinux@vger.kernel.org>);
        Thu, 27 Aug 2020 12:47:38 -0400
Received: from [192.168.4.242] (helo=deadeye)
        by shadbolt.decadent.org.uk with esmtps (TLS1.2:ECDHE_RSA_AES_256_GCM_SHA384:256)
        (Exim 4.89)
        (envelope-from <ben@decadent.org.uk>)
        id 1kBL3o-0005UM-VE; Thu, 27 Aug 2020 17:47:37 +0100
Received: from ben by deadeye with local (Exim 4.94)
        (envelope-from <ben@decadent.org.uk>)
        id 1kBL3o-00DOg2-Dj; Thu, 27 Aug 2020 17:47:36 +0100
Date:   Thu, 27 Aug 2020 17:47:36 +0100
From:   Ben Hutchings <ben@decadent.org.uk>
To:     "David S. Miller" <davem@davemloft.net>
Cc:     sparclinux@vger.kernel.org
Subject: [PATCH] sparc32: signal: Fix stack trampoline for RT signals
Message-ID: <20200827164736.GA3193046@decadent.org.uk>
MIME-Version: 1.0
Content-Type: multipart/signed; micalg=pgp-sha512;
        protocol="application/pgp-signature"; boundary="45Z9DzgjV8m4Oswq"
Content-Disposition: inline
X-SA-Exim-Connect-IP: 192.168.4.242
X-SA-Exim-Mail-From: ben@decadent.org.uk
X-SA-Exim-Scanned: No (on shadbolt.decadent.org.uk); SAEximRunCond expanded to false
Sender: sparclinux-owner@vger.kernel.org
Precedence: bulk
List-ID: <sparclinux.vger.kernel.org>
X-Mailing-List: sparclinux@vger.kernel.org


--45Z9DzgjV8m4Oswq
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
Content-Transfer-Encoding: quoted-printable

The stack trampoline generated by the sparc32 native version of
setup_rt_frame() calls sigreturn(), not rt_sigreturn().  This will
crash the task if it's ever used.  (glibc sets its own restorer, so
was not affected.)

The sparc64 compat implementation has the right syscall number.

This is untested; I have no way to run a sparc32 kernel.

Signed-off-by: Ben Hutchings <ben@decadent.org.uk>
---
 arch/sparc/kernel/signal_32.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/arch/sparc/kernel/signal_32.c b/arch/sparc/kernel/signal_32.c
index 3b005b6c3e0f..c85654cdc2c5 100644
--- a/arch/sparc/kernel/signal_32.c
+++ b/arch/sparc/kernel/signal_32.c
@@ -401,8 +401,8 @@ static int setup_rt_frame(struct ksignal *ksig, struct =
pt_regs *regs,
 	else {
 		regs->u_regs[UREG_I7] =3D (unsigned long)(&(sf->insns[0]) - 2);
=20
-		/* mov __NR_sigreturn, %g1 */
-		err |=3D __put_user(0x821020d8, &sf->insns[0]);
+		/* mov __NR_rt_sigreturn, %g1 */
+		err |=3D __put_user(0x82102065, &sf->insns[0]);
=20
 		/* t 0x10 */
 		err |=3D __put_user(0x91d02010, &sf->insns[1]);

--45Z9DzgjV8m4Oswq
Content-Type: application/pgp-signature; name="signature.asc"

-----BEGIN PGP SIGNATURE-----

iQIzBAABCgAdFiEErCspvTSmr92z9o8157/I7JWGEQkFAl9H46MACgkQ57/I7JWG
EQnaYw//WB04G2UJ78nGVx0JKfeySRcWvm0tAUL2WsQpr4PLSk5JKQfwqrBtcjds
R8c17/rMyP99xrYFcndH8raqJVRxxhRxd5sIDI8I+jXOh3UGXmEs7arBR9m0k071
pNcRQCiZW75l/cCxZH1y8lHl5JGP98FvXS6GO0VyjhdOUYJvv1ipGwU+7FqTYCyF
UDvYvIOomofLTBQQtZim5ncn3IbjVWigjhM/QB4t4+3WBtE52tE35BeN0/xKz6vo
R0EvGAmKyVbWChlcHFS5Lon5m3wNdXMjyaGOgRvbcGua6E4oSahdO7Fm4qFKBNyi
f36vCDibGrL6YkxLBOnuCbIEA4PNo1bjdqbLdDCg2YxsjAUENd7ALFXca4MFYKa+
RFBpceI7LCgJibRIqRrOjKs5RZNFwzR3TDvKgoEsMM3k/kQzs9NeTVIFvfMoBDTM
ik7YCUSJghTGbwcSR3pTcSa3wlKssdc3x7A6MhHQPAccrhsxlcnUwS+sAel0FY/n
7AymVdc6ZZvXWyuNB4RlR0gpUUw42ltmXg0ypdKYzX4RIhru1zIUgORRBRve/beZ
yW5hDO2R/di6ZDcXLaf0KsBPSckvhkW5sPPx83iH8yMYHaw1RMJbloSxXH4bLuFv
swXVSzj3pDF2MGlYXp4FTjylFUBE6rVha0MCVHYa1vIoRgba9ug=
=FEtO
-----END PGP SIGNATURE-----

--45Z9DzgjV8m4Oswq--
